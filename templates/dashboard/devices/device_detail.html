{% extends "dashboard_base.html" %}

{% block sheri %}

<div class="container p-3 mt-5 pt-5">
    <div class="card mb-4 fixed-top m-3">
        <div class="card-body py-2">
            <h4 class="card-title fs-5">رصيدك الحالي</h4>
            <small class="card-text " id="balance" >{{ request.user.profile.balance|floatformat:2 }} USDT</small>
        </div>
    </div>


  <div class="card shadow-sm mx-auto col-9" style="max-width: 24rem;">
    <img src="{{ my_device.device.image.url }}" class="card-img-top rounded-top" alt="{{ my_device.device.name }}">
    <div class="card-body text-center">
      <h5 class="card-title fw-bold">{{ my_device.device.name }}</h5>
      <p class="card-text text-muted small">{{ my_device.device.desc }}</p>

<ul class="list-group mt-3 mb-3 text-start">
  <li class="list-group-item d-flex justify-content-between">
    <span><i class="bi bi-cash-stack text-success"></i> الأرباح</span> 
    <span id="earnings">{{my_device.earnings}}</span>
  </li>
  <li class="list-group-item d-flex justify-content-between">
    <span><i class="bi bi-lightning-charge-fill text-warning"></i> الاستهلاك</span> 
    <span id="wattage">{{my_device.wattage}}</span>
  </li>
  <li class="list-group-item d-flex justify-content-between">
    <span><i class="bi bi-cpu-fill text-primary"></i> الهاش</span> 
    <span id="hashrate">{{my_device.hashrate}}</span>
  </li>
  <li class="list-group-item d-flex justify-content-between">
    <span><i class="bi bi-thermometer-half text-danger"></i> الحرارة</span> 
    <span id="temperature">{{my_device.temperature}}</span>
  </li>
</ul>


      <button type="button" class="btn btn-primary w-100" 
              id="show-next-stage" data-device-id="{{ my_device.id }}">
        عرض المرحلة القادمة
      </button>
    </div>
  </div>

</div>


<script>
function fetchDeviceData() {
  fetch(`/dashboard/devices/detail/{{ my_device.id }}/`)
    .then(response => response.json())
    .then(data => {
      console.log(data)
      document.getElementById("earnings").innerText = data.earnings;
      document.getElementById("balance").innerText = data.balance + " USDT";
      document.getElementById("wattage").innerText = data.wattage + " W";
      document.getElementById("hashrate").innerText = data.hashrate + " MH/s";
      document.getElementById("temperature").innerText = data.temperature + " °C";
    });
}
setInterval(fetchDeviceData, 1000);
fetchDeviceData();
</script>



<!-- Modal: المرحلة القادمة -->
<div class="modal fade" id="nextStageModal" tabindex="-1" aria-labelledby="nextStageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg rounded-4">

      <!-- رأس المودال -->
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="nextStageModalLabel">تفاصيل المرحلة القادمة</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <!-- جسم المودال -->
      <div class="modal-body">
<!-- تنبيه إكمال الطلبات (RTL + Bootstrap) -->
<div dir="rtl" class="alert alert-danger small align-items-start gap-2" role="alert" id="next-done-warning" style="display:none;">
  <div aria-hidden="true" style="font-size:1.25rem;line-height:1">✅</div>
  <div>
    <strong>تهانينا!</strong> أكملت 10 طلبات. يمكنك سحب أرباحك الآن ,وبعدها بدء المستوى التالي.<br>
    <div class="mt-2 d-flex gap-2">
      <a href="{% url 'transactions' %}" class="btn btn-sm btn-success">سحب الأرباح</a>
    </div>
  </div>
</div>



        <ul class="list-group list-group-flush mb-3">
          <li class="list-group-item d-flex justify-content-between">
            <strong>الجهاز:</strong> <span id="stage-device"></span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <strong>المرحلة:</strong> <span id="stage-number"></span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <strong>الطاقة المطلوبة:</strong> <span id="energy-required"></span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <strong>الأرباح المتوقعة:</strong> <span id="profit-after"></span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <strong>الربح الصافي:</strong> <span id="clear-profit" class="badge bg-success"></span>
          </li>
          <li class="list-group-item d-flex justify-content-between">
            <strong>رصيدك الحالي:</strong> <span id="current-balance" class="badge bg-warning"></span>
          </li>
        </ul>

        <div id="balance-warning" class="alert alert-danger small" style="display:none;">
          ⚠️ رصيدك غير كافٍ لتشغيل هذا الجهاز.
        </div>

        <!-- Progress -->
        <label class="form-label fw-bold small">
          التقدم في المراحل: <span id="current-stage"></span>/<span id="total-stages"></span>
        </label>
        <div class="progress mb-2" style="height: 25px;">
          <div id="stage-progress" 
               class="progress-bar progress-bar-striped progress-bar-animated bg-success" 
               role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            0%
          </div>
        </div>

      </div>

      <!-- تذييل المودال -->
      <div class="modal-footer">
<a href="{% url 'next_stage' my_device.id %}" class="btn btn-success w-100" id="start-next-stage">
  <i class="bi bi-rocket-fill me-2"></i> تشغيل الجهاز
</a>

        <button type="button" class="btn btn-secondary w-100" data-bs-dismiss="modal">إغلاق</button>
      </div>

    </div>
  </div>
</div>


<script>
document.getElementById('show-next-stage').addEventListener('click', function() {
  let deviceId = this.dataset.deviceId;
  fetch(`/dashboard/devices/device/${deviceId}/next-stage/`)
    .then(response => response.json())
    .then(data => {
      if(data.error){
        alert(data.error);
        return;
      }

      document.getElementById('stage-device').innerHTML = `${data.device_name} <img src="${data.device_img}" class="rounded ms-2" width="60">`;
      document.getElementById('stage-number').textContent = data.stage;
      document.getElementById('energy-required').textContent = `${data.energy_required}$`;
      document.getElementById('profit-after').textContent = `${data.profit_after}$`;
      document.getElementById('clear-profit').textContent = `${data.clear_profit}$`;
      document.getElementById('current-balance').textContent = `${data.current_balance}$`;
      document.getElementById('stage-progress').textContent = `${data.progress}%`;
      document.getElementById('stage-progress').style.width = `${data.progress}%`;

      

      let modal = new bootstrap.Modal(document.getElementById('nextStageModal'));
      modal.show();

      if (data.stop_continue) {
        document.getElementById('start-next-stage').classList.add("disabled")
        document.getElementById('next-done-warning').style.display = data.next_done_warning ? 'flex' : 'none';
      } else if (!data.can_afford) {
        document.getElementById('balance-warning').style.display = 'block';
        document.getElementById('start-next-stage').classList.add("disabled");
      } else {
        document.getElementById('balance-warning').style.display = 'none';
        document.getElementById('start-next-stage').classList.remove("disabled");
      }
    });
});
</script>

{% endblock sheri %}
