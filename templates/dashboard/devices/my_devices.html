{% extends "dashboard_base.html" %}
{% load i18n %}
{% block sheri %}
<div class="bg-primary p-3">
    <a href="{% url 'devices' %}" class="btn btn-light">Buy devices</a>
</div>

<div class="container p-4 ">
    <h5>My devices</h5>
  <div class="tabel-box">
    <table class="table">
      <thead>
        <tr>
        <th>#</th>
        <th>{% trans "Device ID" %}</th>
        <th>{% trans "Hash power" %}</th>
        <th>{% trans "Temperature" %}</th>
        <th>{% trans "Status" %}</th>
        <th>{% trans "Earnings" %}</th>
        <th>{% trans "Actions" %}</th>
        </tr>
      </thead>
      <tbody id="devices-table-body">
  {% for device in devices %}
  <tr id="device-{{ device.id }}">
     <td>{{ forloop.counter }}</td>
     <td>{{ device.device_id }}</td>
     <td class="hashrate">{{ device.hashrate }} MH/s</td>
     <td class="temperature">{{ device.temperature }} °C</td>
     <td class="status">
       {% if device.status == "running" %}
         <span class="badge bg-success">Running</span>
       {% elif device.status == "stopped" %}
         <span class="badge bg-danger">Stopped</span>
       {% else %}
         <span class="badge bg-warning">Maintenance</span>
       {% endif %}
     </td>
     <td class="earnings">{{ device.earnings }} USDT</td>
     <td>
       <a href="{% url 'device_detail' device.id %}" class="btn btn-sm btn-primary">View</a>
       <a class="btn btn-sm btn-danger" data-bs-toggle="modal" onclick="deleteItem('/usesss')" data-bs-target="#exampleModal">Delete</a>
     </td>
  </tr>
  {% endfor %}
</tbody>

    </table>
  </div>

</div>

<!-- Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content rounded-3 shadow">
      <div class="modal-body p-4 text-center">
        <h5 class="mb-0">Do you want to delete this service?</h5>
        <p class="mb-0">After deletion, you cannot restore it again.</p>
      </div>
      <div class="modal-footer flex-nowrap p-0">
        <a type="button" id="yesDelete" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 py-3 m-0 rounded-0 border-end"><strong>Yes, delete</strong></a>
        <button type="button" class="btn btn-lg btn-link fs-6 text-decoration-none col-6 py-3 m-0 rounded-0" data-bs-dismiss="modal">No, thanks</button>
      </div>
    </div>
  </div>
</div>
<!-- end Modal  -->

<script>
  function deleteItem(id){
    document.querySelector('#yesDelete').href = id
  }
</script>



<script>
function updateDeviceRow(row, data) {
    row.querySelector(".hashrate").textContent = data.hashrate + " MH/s";
    row.querySelector(".temperature").textContent = data.temperature + " °C";
    row.querySelector(".earnings").textContent = data.earnings + " USDT";

    const statusEl = row.querySelector(".status span");
    if(data.status == "running") {
        statusEl.textContent = "Running";
        statusEl.className = "badge bg-success";
    } else if(data.status == "stopped") {
        statusEl.textContent = "Stopped";
        statusEl.className = "badge bg-danger";
    } else {
        statusEl.textContent = "Maintenance";
        statusEl.className = "badge bg-warning";
    }
}

function fetchDeviceUpdatesSequential() {
    fetch("{% url 'devices_status' %}")
    .then(response => response.json())
    .then(data => {
        data.devices.forEach((d, index) => {
            setTimeout(() => {
                const row = document.querySelector(`#device-${d.id}`);
                if(row){
                    updateDeviceRow(row, d);
                }
            }, index * 500); // 500ms between each device
        });
    });
}

// Update every 5 seconds
setInterval(fetchDeviceUpdatesSequential, 5000);
</script>

{% endblock sheri %}
