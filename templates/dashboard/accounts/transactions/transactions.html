{% extends "dashboard_base.html" %}

{% block sheri %}

<div class="container p-4">

    {% comment %} <!-- تحية سريعة -->
    <div class="alert alert-warning" role="alert">
        أهلاً {{ request.user.username }} 👋، لمحة عن استثماراتك
    </div> {% endcomment %}

    <div class="card mb-4">
        <div class="card-body">
            <h4 class="card-title">رصيدك الحالي</h4>
            <p class="card-text display-6">{{ balance|floatformat:2 }} USDT</p>
        </div>
    </div>

    <!-- السحب الخارجي (USDT) -->
    <div class="card mb-4">
        <div class="card-header">سحب / تحويل خارجي (USDT TRC20)</div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="withdraw">
                <div class="mb-3">
                    <label>المبلغ:</label>
                    <input type="number" step="0.000001" name="amount" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>عنوان المحفظة:</label>
                    <input type="text" name="wallet_address" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-primary">تقديم الطلب</button>
            </form>
        </div>
    </div>

    {% if request.user.is_superuser %}
    <!-- التحويل الداخلي -->
    <div class="card mb-4">
        <div class="card-header">تحويل داخلي</div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="action" value="transfer">
                <div class="mb-3">
                    <label>المستلم (اسم المستخدم):</label>
                    <input type="text" name="recipient" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label>المبلغ:</label>
                    <input type="number" step="0.000001" name="amount" class="form-control" required>
                </div>
                <button type="submit" class="btn btn-success">تحويل</button>
            </form>
        </div>
    </div>
{% endif %}
    <!-- سجل المعاملات -->
    <div class="card">
        <div class="card-header">سجل المعاملات</div>
        <div class="card-body table-responsive">
            <table class="table table-bordered table-striped">
                <thead class="table-light">
                    <tr>
                        <th>التاريخ</th>
                        <th>نوع العملية</th>
                        <th>المبلغ</th>
                        <th>المستلم / المحفظة</th>
                        <th>الحالة</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in transactions %}
                    <tr>
                        <td>{{ tx.created_at|date:"Y-m-d H:i" }}</td>
                        <td>{{ tx.get_transaction_type_display }}</td>
                        <td>{{ tx.amount|floatformat:6 }}</td>
                        <td>
                            {% if tx.transaction_type == 'transfer' and tx.to_user %}
                                {{ tx.to_user.username }}
                            {% elif tx.transaction_type == 'withdraw' and tx.wallet_address %}
                                {{ tx.wallet_address }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if tx.transaction_type == 'withdraw' %}
                                {{ tx.get_status_display }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center">لا توجد معاملات حتى الآن</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

{% endblock sheri %}
