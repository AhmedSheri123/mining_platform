{% extends "dashboard_base.html" %}
{% load static %}
{% load i18n %}
{% block links %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.css" />
{% endblock links %}
{% block sheri %}

<!-- نموذج تعديل الملف الشخصي -->
<div class="container p-4 ">
    <h5>{% trans "تعديل الملف الشخصي" %}</h5>

    <form class="bg-body-tertiary p-4 rounded needs-validation" novalidate id="project_form" method="post">
        <div class="text-center">
            {% if user.profile.img_base64 %}
            <div id="cropped-result">
              <div class="carousel-item-content position-relative d-inline-block rounded-circle overflow-hidden" id="cropped-result">
                <img src="{{user.profile.img_base64}}" width="150" alt="..." data-bs-toggle="modal" data-bs-target="#cropImagePop">
                <input type="hidden" value="{{user.profile.img_base64}}" id="userprofile-avatar" name="profile_img" class="form-control" >
                <i class="bi bi-trash-fill position-absolute fixed-bottom bg-dark text-light" role="button" onclick="CarouselOnclickRemove()"></i>
              </div>
            </div>
            {% else %}
            <div id="cropped-result">
              <img src="{% static 'img/profile_default/default-profile-img-2.png' %}" class="d-inline-block rounded-circle mx-auto" width="150" data-bs-toggle="modal" data-bs-target="#cropImagePop">
              <input type="hidden" id="userprofile-avatar" name="profile_img" class="form-control" >
            </div>
            {% endif %}
        </div>

        <!-- زر رفع الصورة -->
        <button type="button" class="btn btn-primary mt-2 mb-4" style="margin: auto;display: block;" data-bs-toggle="modal" data-bs-target="#cropImagePop">
            {% trans "رفع صورة الملف الشخصي" %} 
        </button>

        {% csrf_token %}
        <div class="row row-cols-1 row-cols-md-2">
            <div class="mb-3 col">
                <label class="form-label">
                    <i class="bi bi-pen"></i>
                    {% trans "الاسم الأول" %}
                </label>
                {{user_form.first_name}}
                <div class="valid-feedback">{% trans "جيد!" %}</div>
                <div class="invalid-feedback">{% trans "الرجاء إدخال الاسم الأول." %}</div>
            </div>
            <div class="mb-3 col">
                <label class="form-label">
                    <i class="bi bi-pen"></i>
                    {% trans "الاسم الأخير" %}
                </label>
                {{user_form.last_name}}
                <div class="valid-feedback">{% trans "جيد!" %}</div>
                <div class="invalid-feedback">{% trans "الرجاء إدخال الاسم الأخير." %}</div>
            </div>
            <div class="mb-3 col">
                <label class="form-label">
                    <i class="bi bi-pen"></i>
                    {% trans "البريد الإلكتروني" %}
                </label>
                {{user_form.email}}
                <div class="valid-feedback">{% trans "جيد!" %}</div>
                <div class="invalid-feedback">{% trans "الرجاء إدخال البريد الإلكتروني." %}</div>
            </div>
 
        </div>

        <button type="submit" class="btn btn-primary">
            {% trans "حفظ" %}
            <i class="bi bi-floppy"></i>
        </button>
    </form>
</div>

<!-- Modal تعديل الصورة -->
<div class="modal fade" id="cropImagePop" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content rounded-4 shadow">
            <div class="modal-body p-5">
                <div class="demo-wrap upload-demo mb-5">
                    <div class="container mx-0">
                        <div class="pull-left mb-3">
                            <input type="file" id="upload" class="form-control" accept="image/*" />
                        </div>
                        <div class="pull-left">
                            <div class="upload-msg" onclick="document.querySelector('#upload').click()">
                                {% trans "معاينة" %}
                            </div>
                            <div class="upload-demo-wrap">
                                <div id="upload-demo"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="w-100 mb-2 btn btn-lg rounded-3 btn-primary upload-result" type="submit">{% trans "تغيير" %}</button>
                <button type="button" class="w-100 mb-2 btn btn-lg rounded-3 btn-dark" data-bs-dismiss="modal">{% trans "إغلاق" %}</button>
            </div>
        </div>
    </div>
</div>

<style>
.upload-demo .upload-demo-wrap,
.upload-demo.ready .upload-msg { display: none; }
.upload-demo.ready .upload-result,
.upload-demo.ready .upload-demo-wrap { display: block; }
.cr-boundary, .cr-boundary img { border-radius: 15px !important; }
.upload-demo-wrap { width: min(100%, 300px); height: 300px; margin: 0 auto; }
.upload-msg { text-align: center; padding: 50px; font-size: 22px; color: #aaa; width: 260px; margin: 50px auto; border: 1px solid #aaa; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/croppie/2.6.5/croppie.min.js"></script>
<script>
$(document).ready(function(){
    var $uploadCrop;

    function readFile(input) {
        if (input.files && input.files[0]) {
            var reader = new FileReader();
            reader.onload = function (e) {
                $('.upload-demo').addClass('ready');
                $uploadCrop.croppie('bind', { url: e.target.result });
            }
            reader.readAsDataURL(input.files[0]);
        } else {
            console.log("المتصفح لا يدعم FileReader API");
        }
    }

    $uploadCrop = $('#upload-demo').croppie({
        viewport: { width: 200, height: 200, type: 'circle' },
        enableExif: true
    });

    $('#upload').on('change', function () { readFile(this); });
    $('.upload-result').on('click', function () {
        $uploadCrop.croppie('result', { type: 'canvas', size: 'viewport' }).then(function (resp) {
            $('#userprofile-avatar').val(resp);
            $('#cropped-result img').attr('src',resp);

            
            $('#cropImagePop').modal('hide');
            document.querySelectorAll('.modal-backdrop').forEach(backdrop => backdrop.remove());

        });
    });
});

function CarouselOnclickRemove() {
    let imgBox = document.querySelector('#cropped-result');
    imgBox.querySelector('img').src = default_img_profile;
    imgBox.querySelector('input').value = "";
}
</script>
{% endblock %}
